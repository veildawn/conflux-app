name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  SUBSTORE_VERSION: '2.18.5'
  RELEASE_TAG: ${{ github.event.inputs.tag_name || github.ref_name }}
  RELEASE_NAME: Conflux ${{ github.event.inputs.tag_name || github.ref_name }}

# Workflow-level permissions for GITHUB_TOKEN
permissions:
  contents: write

jobs:
  # Build for macOS ARM64 (Apple Silicon)
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-arm64-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-aarch64-apple-darwin
          key: mihomo-darwin-arm64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-aarch64-apple-darwin" ]; then
            echo "ERROR: mihomo-aarch64-apple-darwin not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -f%z "src-tauri/binaries/mihomo-aarch64-apple-darwin" 2>/dev/null || stat -c%s "src-tauri/binaries/mihomo-aarch64-apple-darwin")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-aarch64-apple-darwin is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-aarch64-apple-darwin verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-aarch64-apple-darwin
          key: node-darwin-arm64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-v${{ env.SUBSTORE_VERSION }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-aarch64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target aarch64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bundles
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for macOS x86_64 (Intel)
  build-macos-x86:
    name: Build macOS x86_64
    runs-on: macos-13
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-x86-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-x86_64-apple-darwin
          key: mihomo-darwin-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-x86_64-apple-darwin" ]; then
            echo "ERROR: mihomo-x86_64-apple-darwin not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -f%z "src-tauri/binaries/mihomo-x86_64-apple-darwin" 2>/dev/null || stat -c%s "src-tauri/binaries/mihomo-x86_64-apple-darwin")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-x86_64-apple-darwin is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-x86_64-apple-darwin verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-apple-darwin
          key: node-darwin-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-v${{ env.SUBSTORE_VERSION }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-x86_64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target x86_64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"

      - name: Upload macOS x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-bundles
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for Windows x86_64
  build-windows-x86:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: windows-rust

      - name: Cache WIX and NSIS toolsets
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\tauri\WixTools
            ~\AppData\Local\tauri\NSIS
          key: windows-tauri-tools-wix314-nsis3.11

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe
          key: mihomo-windows-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: windows-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Build Windows Service
        shell: pwsh
        run: |
          Write-Host "Building Windows TUN service..."
          .\scripts\build-service.ps1 -Release
          if (!(Test-Path "src-tauri/binaries/conflux-service-x86_64-pc-windows-msvc.exe")) {
            Write-Error "Service build failed!"
            exit 1
          }
          Write-Host "‚úÖ Windows service built successfully"

      - name: Verify MiHomo binaries
        shell: bash
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe" ]; then
            echo "ERROR: mihomo-x86_64-pc-windows-msvc.exe not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe" 2>/dev/null || wc -c < "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-x86_64-pc-windows-msvc.exe is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-x86_64-pc-windows-msvc.exe verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-pc-windows-msvc.exe
          key: node-win-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: win-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-v${{ env.SUBSTORE_VERSION }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        shell: bash
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        shell: bash
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-x86_64-pc-windows-msvc.exe" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (Windows x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target x86_64-pc-windows-msvc -c src-tauri/tauri.windows.conf.json

      - name: Verify build artifacts
        shell: bash
        run: |
          echo "=== Checking build artifacts ==="
          echo "NSIS installers:"
          find src-tauri/target -name "*-setup.exe" -exec ls -lh {} \; 2>/dev/null || echo "No NSIS installer found"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64-bundles
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*-setup.exe
          if-no-files-found: error

  # Create a combined release after all builds complete
  finalize-release:
    name: Finalize Release
    needs: [build-macos-arm64, build-macos-x86, build-windows-x86]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate changelog from commits
        id: changelog
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ env.RELEASE_TAG }}"

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"

          # Êî∂ÈõÜ commits
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || true)
          else
            COMMITS=$(git log --pretty=format:"%s" 2>/dev/null | head -30 || true)
          fi

          # ÂàÜÁ±ªÁªüËÆ°
          FEAT_COMMITS=$(echo "$COMMITS" | grep "^feat" | sed 's/^feat[:(] *//; s/)$//' || true)
          FIX_COUNT=$(echo "$COMMITS" | grep -c "^fix" || echo "0")
          PERF_COMMITS=$(echo "$COMMITS" | grep "^perf\|^refactor\|^ci" | sed 's/^\(perf\|refactor\|ci\)[:(] *//; s/)$//' || true)

          # Â¶ÇÊûúÊúâÊô∫Ë∞± API KeyÔºå‰ΩøÁî® AI ÁîüÊàêÊèèËø∞
          if [ -n "$ZHIPU_API_KEY" ] && [ -n "$FEAT_COMMITS" ]; then
            echo "ü§ñ Using Zhipu AI to generate release notes..."

            # ÊûÑÂª∫ AI ËØ∑Ê±Ç
            FEAT_LIST=$(echo "$FEAT_COMMITS" | head -10 | tr '\n' '|' | sed 's/|$//')

            AI_RESPONSE=$(curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
              -H "Authorization: Bearer $ZHIPU_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"model\": \"glm-4.5-flash\",
                \"messages\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑËΩØ‰ª∂ÂèëÂ∏ÉËØ¥ÊòéÊí∞ÂÜôËÄÖ„ÄÇËØ∑Â∞Ü git commit ‰ø°ÊÅØËΩ¨Êç¢‰∏∫Áî®Êà∑ÂèãÂ•ΩÁöÑ‰∏≠ÊñáÊõ¥Êñ∞ËØ¥Êòé„ÄÇË¶ÅÊ±ÇÔºö1. ÊØèÊù°ÂäüËÉΩÁî®‰∏ÄÂè•ËØùÊèèËø∞ÔºåÁ™ÅÂá∫ÂØπÁî®Êà∑ÁöÑ‰ª∑ÂÄº 2. ‰ΩøÁî®ÁÆÄÊ¥ÅÊòìÊáÇÁöÑËØ≠Ë®Ä 3. ÊØèÊù°ÂâçÈù¢Âä†‰∏äÂêàÈÄÇÁöÑ emoji 4. Áõ¥Êé•ËæìÂá∫ÂàóË°®Ôºå‰∏çË¶ÅÂä†Ê†áÈ¢ò\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": \"ËØ∑Â∞Ü‰ª•‰∏ãÂäüËÉΩÊõ¥Êñ∞ËΩ¨Êç¢‰∏∫Áî®Êà∑ÂèãÂ•ΩÁöÑËØ¥ÊòéÔºö${FEAT_LIST}\"
                  }
                ],
                \"temperature\": 0.7,
                \"max_tokens\": 500
              }" 2>/dev/null || echo "")

            # ÊèêÂèñ AI ÂìçÂ∫îÂÜÖÂÆπ
            if [ -n "$AI_RESPONSE" ]; then
              AI_FEATURES=$(echo "$AI_RESPONSE" | python3 -c "import sys,json; data=json.load(sys.stdin); print(data.get('choices',[{}])[0].get('message',{}).get('content',''))" 2>/dev/null || echo "")
            fi
          fi

          # ÁîüÊàê changelog
          {
            echo "CHANGELOG<<EOF"

            # Êñ∞ÂäüËÉΩ
            echo "## ‚ú® Êñ∞ÂäüËÉΩ"
            echo ""
            if [ -n "$AI_FEATURES" ]; then
              echo "$AI_FEATURES"
            elif [ -n "$FEAT_COMMITS" ]; then
              echo "$FEAT_COMMITS" | while read -r line; do
                [ -n "$line" ] && echo "- $line"
              done
            else
              echo "_Êú¨ÁâàÊú¨Êó†Êñ∞ÂäüËÉΩ_"
            fi
            echo ""

            # ‰ºòÂåñÊîπËøõ
            echo "## üöÄ ‰ºòÂåñÊîπËøõ"
            echo ""
            if [ -n "$PERF_COMMITS" ]; then
              echo "$PERF_COMMITS" | head -5 | while read -r line; do
                [ -n "$line" ] && echo "- $line"
              done
            else
              echo "_Êú¨ÁâàÊú¨Êó†‰ºòÂåñÊîπËøõ_"
            fi
            echo ""

            # Bug ‰øÆÂ§ç - Âè™ÊòæÁ§∫Êï∞Èáè
            echo "## üêõ Bug ‰øÆÂ§ç"
            echo ""
            if [ "$FIX_COUNT" -gt 0 ]; then
              echo "‰øÆÂ§ç‰∫Ü **${FIX_COUNT}** ‰∏™ÈóÆÈ¢ò"
            else
              echo "_Êú¨ÁâàÊú¨Êó† Bug ‰øÆÂ§ç_"
            fi
            echo ""

            # ÂÆâË£ÖËØ¥Êòé
            echo "---"
            echo ""
            echo "## üì• ÂÆâË£ÖËØ¥Êòé"
            echo ""
            echo "| Âπ≥Âè∞ | Êñá‰ª∂ | ËØ¥Êòé |"
            echo "|------|------|------|"
            echo "| macOS (Apple Silicon) | \`Conflux_x.x.x_aarch64.dmg\` | M1/M2/M3/M4 ËäØÁâá |"
            echo "| macOS (Intel) | \`Conflux_x.x.x_x64.dmg\` | Intel ËäØÁâá |"
            echo "| Windows | \`Conflux_x.x.x_x64-setup.exe\` | 64 ‰Ωç Windows |"
            echo ""
            echo "### macOS È¶ñÊ¨°ÂÆâË£Ö"
            echo ""
            echo "Áî±‰∫éÂ∫îÁî®Êú™Á≠æÂêçÔºåÈ¶ñÊ¨°ÂÆâË£ÖÂêéÈúÄË¶ÅÁßªÈô§ÈöîÁ¶ªÂ±ûÊÄßÔºö"
            echo ""
            echo "\`\`\`bash"
            echo "sudo xattr -rd com.apple.quarantine \"/Applications/Conflux.app\""
            echo "\`\`\`"

            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: true
          prerelease: false
          target_commitish: ${{ github.sha }}
          files: release-assets/**/*
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Release Summary
        run: |
          echo "‚úÖ All platform builds completed successfully!"
          echo ""
          echo "üì¶ Built artifacts:"
          echo "  - macOS ARM64 (Apple Silicon): .dmg"
          echo "  - macOS x86_64 (Intel): .dmg"
          echo "  - Windows x86_64: NSIS installer (.exe)"
          echo ""
          echo "üîó Release: https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}"
