name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v0.1.0)'
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build for macOS ARM64 (Apple Silicon)
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Fetch MiHomo binaries
        shell: bash
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app (macOS ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Apple code signing (optional, configure secrets if needed)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.event.inputs.tag_name || github.ref_name }}
          releaseName: 'Conflux ${{ github.event.inputs.tag_name || github.ref_name }}'
          releaseBody: |
            ## Changes
            See the assets below to download and install.
            
            ### Installation
            - **macOS ARM64 (Apple Silicon)**: Download `.dmg` file for M1/M2/M3 Macs
            - **macOS x86_64 (Intel)**: Download `.dmg` file for Intel Macs
            - **Windows x86_64**: Download `.msi` or `.exe` installer
          releaseDraft: true
          prerelease: false
          args: --target aarch64-apple-darwin -c src-tauri/tauri.macos.conf.json
          includeUpdaterJson: true

  # Build for macOS x86_64 (Intel)
  build-macos-x86:
    name: Build macOS x86_64
    runs-on: macos-13  # macOS 13 runs on Intel hardware
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Fetch MiHomo binaries
        shell: bash
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app (macOS x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Apple code signing (optional)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.event.inputs.tag_name || github.ref_name }}
          releaseName: 'Conflux ${{ github.event.inputs.tag_name || github.ref_name }}'
          releaseBody: |
            ## Changes
            See the assets below to download and install.
          releaseDraft: true
          prerelease: false
          args: --target x86_64-apple-darwin -c src-tauri/tauri.macos.conf.json
          includeUpdaterJson: true

  # Build for Windows x86_64
  build-windows-x86:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Fetch MiHomo binaries
        shell: bash
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app (Windows x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Windows code signing (optional)
          # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.event.inputs.tag_name || github.ref_name }}
          releaseName: 'Conflux ${{ github.event.inputs.tag_name || github.ref_name }}'
          releaseBody: |
            ## Changes
            See the assets below to download and install.
          releaseDraft: true
          prerelease: false
          args: --target x86_64-pc-windows-msvc -c src-tauri/tauri.windows.conf.json
          includeUpdaterJson: true

  # Optional: Create a combined release after all builds complete
  finalize-release:
    name: Finalize Release
    needs: [build-macos-arm64, build-macos-x86, build-windows-x86]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Release Summary
        run: |
          echo "âœ… All platform builds completed successfully!"
          echo ""
          echo "ðŸ“¦ Built artifacts:"
          echo "  - macOS ARM64 (Apple Silicon): .dmg"
          echo "  - macOS x86_64 (Intel): .dmg"  
          echo "  - Windows x86_64: .msi, .exe"
          echo ""
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag_name || github.ref_name }}"
