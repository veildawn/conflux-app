name: Release
run-name: Release ${{ inputs.tag_name || github.ref_name }}

# Build and publish release artifacts for all platforms
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  SUBSTORE_VERSION: 'latest'
  RELEASE_TAG: ${{ github.event.inputs.tag_name || github.ref_name }}
  RELEASE_NAME: Conflux ${{ github.event.inputs.tag_name || github.ref_name }}

# Workflow-level permissions for GITHUB_TOKEN
permissions:
  contents: write

jobs:
  # Build for macOS ARM64 (Apple Silicon)
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-arm64-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-aarch64-apple-darwin
          key: mihomo-darwin-arm64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-aarch64-apple-darwin" ]; then
            echo "ERROR: mihomo-aarch64-apple-darwin not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -f%z "src-tauri/binaries/mihomo-aarch64-apple-darwin" 2>/dev/null || stat -c%s "src-tauri/binaries/mihomo-aarch64-apple-darwin")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-aarch64-apple-darwin is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-aarch64-apple-darwin verified: $FILE_SIZE bytes"

      - name: Build macOS TUN Helper
        run: |
          echo "Building macOS TUN helper..."
          cd src-tauri/helper
          cargo build --release
          cp target/release/conflux-helper ../binaries/helper-aarch64-apple-darwin
          echo "‚úÖ macOS helper built successfully"
          ls -lh ../binaries/helper-*

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-aarch64-apple-darwin
          key: node-darwin-arm64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-${{ github.run_id }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-aarch64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target aarch64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bundles
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for macOS x86_64 (Intel)
  build-macos-x86:
    name: Build macOS x86_64
    runs-on: macos-15-intel
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-x86-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-x86_64-apple-darwin
          key: mihomo-darwin-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-x86_64-apple-darwin" ]; then
            echo "ERROR: mihomo-x86_64-apple-darwin not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -f%z "src-tauri/binaries/mihomo-x86_64-apple-darwin" 2>/dev/null || stat -c%s "src-tauri/binaries/mihomo-x86_64-apple-darwin")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-x86_64-apple-darwin is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-x86_64-apple-darwin verified: $FILE_SIZE bytes"

      - name: Build macOS TUN Helper
        run: |
          echo "Building macOS TUN helper..."
          cd src-tauri/helper
          cargo build --release
          cp target/release/conflux-helper ../binaries/helper-x86_64-apple-darwin
          echo "‚úÖ macOS helper built successfully"
          ls -lh ../binaries/helper-*

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-apple-darwin
          key: node-darwin-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-${{ github.run_id }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-x86_64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target x86_64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"

      - name: Upload macOS x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-bundles
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for Windows x86_64
  build-windows-x86:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: windows-rust

      - name: Cache WIX and NSIS toolsets
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\tauri\WixTools
            ~\AppData\Local\tauri\NSIS
          key: windows-tauri-tools-wix314-nsis3.11

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe
          key: mihomo-windows-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: windows-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Build Windows Service
        shell: pwsh
        run: |
          Write-Host "Building Windows TUN service..."
          .\scripts\build-service.ps1 -Release
          if (!(Test-Path "src-tauri/binaries/conflux-service-x86_64-pc-windows-msvc.exe")) {
            Write-Error "Service build failed!"
            exit 1
          }
          Write-Host "‚úÖ Windows service built successfully"

      - name: Verify MiHomo binaries
        shell: bash
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/binaries/
          if [ ! -f "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe" ]; then
            echo "ERROR: mihomo-x86_64-pc-windows-msvc.exe not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe" 2>/dev/null || wc -c < "src-tauri/binaries/mihomo-x86_64-pc-windows-msvc.exe")
          MIN_SIZE=10000000
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-x86_64-pc-windows-msvc.exe is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-x86_64-pc-windows-msvc.exe verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-pc-windows-msvc.exe
          key: node-win-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: win-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-${{ github.run_id }}

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify Sub-Store frontend
        id: verify-frontend
        shell: bash
        run: |
          if [ ! -d "src-tauri/resources/sub-store/frontend" ] || [ -z "$(ls -A src-tauri/resources/sub-store/frontend 2>/dev/null)" ]; then
            echo "frontend_missing=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Sub-Store frontend directory is missing or empty"
          else
            echo "frontend_missing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Sub-Store frontend directory exists"
          fi

      - name: Re-fetch Sub-Store (frontend missing)
        if: steps.verify-frontend.outputs.frontend_missing == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "Re-fetching Sub-Store due to missing frontend..."
          rm -rf src-tauri/resources/sub-store
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        shell: bash
        run: |
          echo "=== Verifying all required resources ==="
          if [ ! -f "src-tauri/binaries/node-x86_64-pc-windows-msvc.exe" ]; then
            echo "ERROR: Node.js binary not found!"; exit 1
          fi
          echo "‚úÖ Node.js binary present"
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"
          if [ ! -f "src-tauri/resources/sub-store/frontend/index.html" ]; then
            echo "ERROR: Sub-Store frontend index.html not found!"; exit 1
          fi
          echo "‚úÖ Sub-Store frontend present"
          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (Windows x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: --target x86_64-pc-windows-msvc -c src-tauri/tauri.windows.conf.json

      - name: Verify build artifacts
        shell: bash
        run: |
          echo "=== Checking build artifacts ==="
          echo "NSIS installers:"
          find src-tauri/target -name "*-setup.exe" -exec ls -lh {} \; 2>/dev/null || echo "No NSIS installer found"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64-bundles
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*-setup.exe
          if-no-files-found: error

  # Create a combined release after all builds complete
  finalize-release:
    name: Finalize Release
    needs: [build-macos-arm64, build-macos-x86, build-windows-x86]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate changelog from commits
        id: changelog
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ env.RELEASE_TAG }}"

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"

          # Êî∂ÈõÜ commits
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || true)
          else
            COMMITS=$(git log --pretty=format:"%s" 2>/dev/null | head -30 || true)
          fi

          # ÂàÜÁ±ªÁªüËÆ°Âπ∂ÂéªÈáç
          FEAT_COMMITS=$(echo "$COMMITS" | grep "^feat" | sed 's/^feat[:(] *//; s/)$//' | sort -u || true)
          FIX_COMMITS=$(echo "$COMMITS" | grep "^fix" | sed 's/^fix[:(] *//; s/)$//' | sort -u || true)
          FIX_COUNT=$(echo "$COMMITS" | grep -c "^fix" || echo "0")
          PERF_COMMITS=$(echo "$COMMITS" | grep "^perf\|^refactor\|^ci" | sed 's/^\(perf\|refactor\|ci\)[:(] *//; s/)$//' | sort -u || true)

          # ÂêàÂπ∂ÊâÄÊúâÈúÄË¶Å AI Â§ÑÁêÜÁöÑÂÜÖÂÆπ
          ALL_COMMITS=""
          [ -n "$FEAT_COMMITS" ] && ALL_COMMITS="${ALL_COMMITS}[Êñ∞ÂäüËÉΩ] ${FEAT_COMMITS}"$'\n'
          [ -n "$FIX_COMMITS" ] && ALL_COMMITS="${ALL_COMMITS}[‰øÆÂ§ç] ${FIX_COMMITS}"$'\n'
          [ -n "$PERF_COMMITS" ] && ALL_COMMITS="${ALL_COMMITS}[‰ºòÂåñ] ${PERF_COMMITS}"

          # Â¶ÇÊûúÊúâÊô∫Ë∞± API Key ‰∏îÊúâÂÜÖÂÆπÔºå‰ΩøÁî® AI ÁîüÊàêÊèèËø∞
          if [ -n "$ZHIPU_API_KEY" ] && [ -n "$ALL_COMMITS" ]; then
            echo "ü§ñ Using Zhipu AI to generate release notes..."

            # ËΩ¨Êç¢‰∏∫ÂçïË°åÔºåÁî® | ÂàÜÈöî
            COMMIT_LIST=$(echo "$ALL_COMMITS" | tr '\n' '|' | sed 's/|$//')

            AI_RESPONSE=$(curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
              -H "Authorization: Bearer $ZHIPU_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"model\": \"glm-4-flash\",
                \"messages\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"‰Ω†ÊòØ‰∏ì‰∏öÁöÑÁâàÊú¨ÂèëÂ∏ÉÊó•ÂøóÁºñËæë„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂ∞Ü git commit Êï¥ÁêÜÊàêÊ∏ÖÊô∞„ÄÅÁî®Êà∑ÂèãÂ•ΩÁöÑ‰∏≠ÊñáÊõ¥Êñ∞ËØ¥Êòé„ÄÇ\\n\\n# Ê†∏ÂøÉÂéüÂàô\\n1. **Áî®Êà∑ËßÜËßí**ÔºöÂè™Â±ïÁ§∫ÂØπÁî®Êà∑ÊúâÊÑüÁü•ÁöÑÂäüËÉΩÂíå‰øÆÂ§ç„ÄÇ**ÁªùÂØπÂøΩÁï•**Á∫ØÊäÄÊúØÊÄßÁöÑÊõ¥Êñ∞ÔºàÂ¶Ç \\\"CI\\\", \\\"workflow\\\", \\\"chore\\\", \\\"refactor\\\"ÔºâÔºåÈô§ÈùûÂÆÉÁõ¥Êé•‰øÆÂ§ç‰∫ÜÁî®Êà∑ÂèØËßÅÁöÑ Bug„ÄÇ\\n2. **ÈöêËóèÊäÄÊúØÁªÜËäÇ**ÔºöÊâÄÊúâÂÜÖÈÉ®‰ª£Á†Å‰ºòÂåñ„ÄÅÊûÑÂª∫ÊµÅÁ®ãË∞ÉÊï¥ÔºåÁªü‰∏ÄÂêàÂπ∂‰∏∫ \\\"üõ† ÂÜÖÈÉ®‰ª£Á†Å‰ºòÂåñ‰∏éÊÄßËÉΩÊèêÂçá\\\"„ÄÇ\\n3. **ÂΩªÂ∫ïÂéªÈáç**ÔºöÁõ∏‰ººÂÜÖÂÆπÁöÑÊèê‰∫§ÂøÖÈ°ªÂêàÂπ∂„ÄÇ\\n\\n# ËØ¶ÁªÜËßÑÂàô\\n1. **[‚ú® Êñ∞ÂäüËÉΩ]**\\n   - ÈáçÁÇπÂ±ïÁ§∫ÔºöÊñ∞Â¢ûÂä†ÁöÑÊ†∏ÂøÉÂäüËÉΩ„ÄÇ\\n   - **ÂøΩÁï•**Ôºö‰ªª‰ΩïÂÖ≥‰∫é \\\"Release workflow\\\" Êàñ \\\"CI\\\" ÁöÑÊñ∞Â¢ûÂäüËÉΩ„ÄÇ\\n2. **[üêõ Bug ‰øÆÂ§ç]**\\n   - **ÈáçÁÇπÂåÖÂê´**ÔºöÂΩ±ÂìçÁî®Êà∑Êï∞ÊçÆ„ÄÅÂ∫îÁî®ÂêØÂä®„ÄÅÊ†∏ÂøÉÂäüËÉΩÁöÑ‰∏•Èáç Bug„ÄÇ\\n   - **‰∏•Á¶ÅÂåÖÂê´**Ôºö‰ªª‰ΩïÂÖ≥‰∫é CI„ÄÅWorkflow„ÄÅRelease Script ÁöÑ‰øÆÂ§çÔºàÂ¶Ç \\\"fix heredoc\\\", \\\"workflow name\\\" Á≠âÔºâÔºåËøô‰∫õÂ±û‰∫éÂÜÖÈÉ®‰ºòÂåñ„ÄÇ\\n3. **[üöÄ ‰ºòÂåñÊîπËøõ]**\\n   - Â∞ÜÊâÄÊúâÊñáÊ°£Êõ¥Êñ∞„ÄÅRelease Notes ÁîüÊàêÈÄªËæë„ÄÅPrompt Ë∞ÉÊï¥ÂêàÂπ∂‰∏∫ 1 Êù°ÊèèËø∞„ÄÇ\\n\\n# ËæìÂá∫Ê†ºÂºè\\n- ‰∏•Ê†º Markdown Ê†ºÂºè„ÄÇ\\n- ÊØè‰∏ÄÈ°πÂøÖÈ°ª‰ª• emoji ÂºÄÂ§¥„ÄÇ\\n- ËØ≠Ë®ÄÈ£éÊ†ºÔºöÁÆÄÊ¥Å„ÄÅÊúâÂäõ„ÄÇ\\n\\nËæìÂá∫Á§∫‰æãÔºö\\n## ‚ú® Êñ∞ÂäüËÉΩ\\n- üç∫ ÊîØÊåÅÈÄöËøá Homebrew ‰∏ÄÈîÆÂÆâË£ÖÂíåÊõ¥Êñ∞\\n\\n## üêõ Bug ‰øÆÂ§ç\\n- üîÑ ÂΩªÂ∫ï‰øÆÂ§ç‰∫ëÁ´ØÂêåÊ≠•ÂäüËÉΩÔºåÁé∞Âú®ÂèØÂÆåÊï¥Â§á‰ªΩËµÑÊ∫ê„ÄÅËßÑÂàôÈõÜÂíå Sub-Store Êï∞ÊçÆ\\n- üîß ‰øÆÂ§ç‰∫Ü Intel ËäØÁâá Mac ‰∏äÁöÑÂêØÂä®Â¥©Ê∫ÉÈóÆÈ¢ò\\n- üì¶ ‰øÆÂ§ç‰∫Ü Sub-Store ÂâçÁ´ØËµÑÊ∫ê‰∏ãËΩΩÂ§±Ë¥•ÁöÑÈóÆÈ¢ò\\n\\n## üöÄ ‰ºòÂåñÊîπËøõ\\n- üõ† ÂÆåÂñÑ‰∫ÜËá™Âä®ÂåñÂèëÂ∏ÉÊµÅÁ®ãÔºåÊèêÂçáÊûÑÂª∫Á®≥ÂÆöÊÄß\\n- ‚ö°Ô∏è ËøõË°å‰∫ÜÂ§öÈ°πÂÜÖÈÉ®‰ª£Á†Å‰ºòÂåñ\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": \"${COMMIT_LIST}\"
                  }
                ],
                \"temperature\": 0.3,
                \"max_tokens\": 500
              }" 2>/dev/null || echo "")

            # ÊèêÂèñ AI ÂìçÂ∫îÂÜÖÂÆπ
            if [ -n "$AI_RESPONSE" ]; then
              AI_CONTENT=$(echo "$AI_RESPONSE" | python3 -c "import sys,json; data=json.load(sys.stdin); print(data.get('choices',[{}])[0].get('message',{}).get('content',''))" 2>/dev/null || echo "")
            fi
          fi

          # ÁîüÊàê changelog
          {
            echo "CHANGELOG<<EOF"

            HAS_CONTENT=false

            # Â¶ÇÊûú AI ÁîüÊàê‰∫ÜÂÜÖÂÆπÔºåÁõ¥Êé•‰ΩøÁî®
            if [ -n "$AI_CONTENT" ]; then
              echo "$AI_CONTENT"
              echo ""
              HAS_CONTENT=true
            else
              # ÂõûÈÄÄÂà∞ÂéüÂßãÈÄªËæë
              if [ -n "$FEAT_COMMITS" ]; then
                echo "## ‚ú® Êñ∞ÂäüËÉΩ"
                echo ""
                echo "$FEAT_COMMITS" | head -5 | while read -r line; do
                  [ -n "$line" ] && echo "- $line"
                done
                echo ""
                HAS_CONTENT=true
              fi

              if [ -n "$PERF_COMMITS" ]; then
                echo "## üöÄ ‰ºòÂåñÊîπËøõ"
                echo ""
                echo "$PERF_COMMITS" | head -3 | while read -r line; do
                  [ -n "$line" ] && echo "- $line"
                done
                echo ""
                HAS_CONTENT=true
              fi

              # Bug ‰øÆÂ§çÔºà‰ªÖÂú®Ê≤°Êúâ AI ÁîüÊàêÊó∂ÊòæÁ§∫Ôºâ
              if [ "$FIX_COUNT" -gt 0 ]; then
                echo "## üêõ Bug ‰øÆÂ§ç"
                echo ""
                if [ -n "$FIX_COMMITS" ]; then
                  echo "$FIX_COMMITS" | head -5 | while read -r line; do
                    [ -n "$line" ] && echo "- $line"
                  done
                  REMAINING=$((FIX_COUNT - 5))
                  if [ "$REMAINING" -gt 0 ]; then
                    echo "- ‰ª•ÂèäÂÖ∂‰ªñ $REMAINING ‰∏™Â∞èÈóÆÈ¢ò‰øÆÂ§ç"
                  fi
                else
                  echo "‰øÆÂ§ç‰∫Ü **${FIX_COUNT}** ‰∏™ÈóÆÈ¢ò"
                fi
                echo ""
                HAS_CONTENT=true
              fi
            fi

            # Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÊõ¥Êñ∞ÂÜÖÂÆπ
            if [ "$HAS_CONTENT" = false ]; then
              echo "## üì¶ ÁâàÊú¨Êõ¥Êñ∞"
              echo ""
              echo "Â∏∏ËßÑÁª¥Êä§Êõ¥Êñ∞"
              echo ""
            fi

            # ÂÆâË£ÖËØ¥Êòé
            echo "---"
            echo ""
            echo "## üì• ‰∏ãËΩΩÂÆâË£Ö"
            echo ""
            echo "### üç∫ Homebrew (macOS Êé®Ëçê)"
            echo "\`\`\`bash"
            echo "brew tap veildawn/cask"
            echo "brew update"
            echo "brew install --cask conflux --no-quarantine --force"
            echo "\`\`\`"
            echo "> ‰ΩøÁî® \`--no-quarantine\` ÂèÇÊï∞ÂèØËá™Âä®Ëß£ÂÜ≥\"Â∑≤ÊçüÂùè\"ÊèêÁ§∫Ôºå‰ΩøÁî® \`--force\` ÂèÇÊï∞ÂèØË¶ÜÁõñÊâãÂä®ÂÆâË£ÖÁöÑÁâàÊú¨„ÄÇ"
            echo ""
            echo "### üì¶ ÊâãÂä®‰∏ãËΩΩ"
            echo ""
            echo "| Á≥ªÁªü | ‰∏ãËΩΩÊñá‰ª∂ | ÈÄÇÁî®ËÆæÂ§á |"
            echo "|:-----|:---------|:---------|"
            echo "| macOS | \`*_aarch64.dmg\` | M Á≥ªÂàóËäØÁâá Mac |"
            echo "| macOS | \`*_x64.dmg\` | Intel ËäØÁâá Mac |"
            echo "| Windows | \`*_x64-setup.exe\` | Windows 10/11 |"
            echo ""
            echo "### ‚ö†Ô∏è ÈáçË¶ÅÊèêÁ§∫ (macOS ÊâãÂä®ÂÆâË£Ö)"
            echo "Â¶ÇÊûúÊÇ®ÊâãÂä®‰∏ãËΩΩ \`.dmg\` ÂÆâË£ÖÔºàÂåÖÊã¨Ë¶ÜÁõñÊõ¥Êñ∞ÔºâÔºåÈ¶ñÊ¨°ÊâìÂºÄÂ¶ÇÈÅá **\"Â∑≤ÊçüÂùè\"** Êàñ **\"Êó†Ê≥ïÊâìÂºÄ\"** ÊèêÁ§∫ÔºåËØ∑Âä°ÂøÖÂú®ÁªàÁ´ØÊâßË°å‰ª•‰∏ãÂëΩ‰ª§‰øÆÂ§çÔºö"
            echo "\`\`\`bash"
            echo "sudo xattr -rd com.apple.quarantine /Applications/Conflux.app"
            echo "\`\`\`"

            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          make_latest: true
          target_commitish: ${{ github.sha }}
          files: release-assets/**/*
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        if: success()
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$HOMEBREW_TAP_TOKEN" ]; then
            echo "‚ö†Ô∏è HOMEBREW_TAP_TOKEN not set, skipping Homebrew tap update"
            exit 0
          fi

          VERSION="${RELEASE_TAG#v}"
          echo "üì¶ Updating Homebrew tap for version $VERSION..."

          # Calculate SHA256 for DMG files
          ARM64_DMG="release-assets/Conflux_${VERSION}_aarch64.dmg"
          X64_DMG="release-assets/Conflux_${VERSION}_x64.dmg"

          if [ -f "$ARM64_DMG" ] && [ -f "$X64_DMG" ]; then
            ARM64_SHA=$(shasum -a 256 "$ARM64_DMG" | cut -d' ' -f1)
            X64_SHA=$(shasum -a 256 "$X64_DMG" | cut -d' ' -f1)

            echo "  ARM64 SHA256: $ARM64_SHA"
            echo "  x64 SHA256: $X64_SHA"

            # Clone homebrew tap repo
            git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/veildawn/homebrew-cask.git" homebrew-tap
            cd homebrew-tap

            # Update Cask file
            mkdir -p Casks
            cat > Casks/conflux.rb << 'CASK'
            # typed: false
            # frozen_string_literal: true

            cask "conflux" do
          CASK
            echo "  version \"$VERSION\"" >> Casks/conflux.rb
            cat >> Casks/conflux.rb << 'CASK'

              on_intel do
          CASK
            echo "    sha256 \"$X64_SHA\"" >> Casks/conflux.rb
            cat >> Casks/conflux.rb << 'CASK'
                url "https://github.com/veildawn/conflux-app/releases/download/v#{version}/Conflux_#{version}_x64.dmg",
                    verified: "github.com/veildawn/conflux-app/"
              end

              on_arm do
          CASK
            echo "    sha256 \"$ARM64_SHA\"" >> Casks/conflux.rb
            cat >> Casks/conflux.rb << 'CASK'
                url "https://github.com/veildawn/conflux-app/releases/download/v#{version}/Conflux_#{version}_aarch64.dmg",
                    verified: "github.com/veildawn/conflux-app/"
              end

              name "Conflux"
              desc "Modern proxy management app based on MiHomo"
              homepage "https://github.com/veildawn/conflux-app"

              livecheck do
                url :url
                strategy :github_latest
              end

              app "Conflux.app"

              postflight do
                system_command "/usr/bin/xattr",
                               args: ["-rd", "com.apple.quarantine", "#{appdir}/Conflux.app"],
                               sudo: false
              end

              zap trash: [
                "~/Library/Application Support/com.conflux.desktop",
                "~/Library/Caches/com.conflux.desktop",
                "~/Library/Preferences/com.conflux.desktop.plist",
                "~/Library/Saved Application State/com.conflux.desktop.savedState",
              ]
            end
          CASK

            # Commit and push
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add Casks/conflux.rb
            git commit -m "Update conflux to $VERSION" || echo "No changes to commit"
            git push

            echo "‚úÖ Homebrew tap updated!"
          else
            echo "‚ö†Ô∏è DMG files not found, skipping Homebrew tap update"
          fi

      - name: Release Summary
        run: |
          echo "‚úÖ All platform builds completed successfully!"
          echo ""
          echo "üì¶ Built artifacts:"
          echo "  - macOS ARM64 (Apple Silicon): .dmg"
          echo "  - macOS x86_64 (Intel): .dmg"
          echo "  - Windows x86_64: NSIS installer (.exe)"
          echo ""
          echo "üîó Release: https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}"
