name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RELEASE_TAG: ${{ github.event.inputs.tag_name || github.ref_name }}
  RELEASE_NAME: Conflux ${{ github.event.inputs.tag_name || github.ref_name }}
  RELEASE_BODY: |
    ## Changes
    See the assets below to download and install.
    
    ### Installation
    - **macOS ARM64 (Apple Silicon)**: Download `.dmg` file for M1/M2/M3 Macs
    - **macOS x86_64 (Intel)**: Download `.dmg` file for Intel Macs
    - **Windows x86_64**: Download `.msi` or `.exe` installer

# Workflow-level permissions for GITHUB_TOKEN
permissions:
  contents: write

jobs:
  # Build for macOS ARM64 (Apple Silicon)
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/mihomo-darwin-arm64
          key: mihomo-darwin-arm64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/resources/

          # Check if file exists
          if [ ! -f "src-tauri/resources/mihomo-darwin-arm64" ]; then
            echo "ERROR: mihomo-darwin-arm64 not found!"
            exit 1
          fi

          # Check file size (should be > 10MB)
          FILE_SIZE=$(stat -f%z "src-tauri/resources/mihomo-darwin-arm64" 2>/dev/null || stat -c%s "src-tauri/resources/mihomo-darwin-arm64")
          MIN_SIZE=10000000  # 10MB
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-darwin-arm64 is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-darwin-arm64 verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-aarch64-apple-darwin
          key: node-darwin-arm64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-arm64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-latest-v1

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="

          # Check Node.js
          if [ ! -f "src-tauri/binaries/node-aarch64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"
            exit 1
          fi
          echo "‚úÖ Node.js binary present"

          # Check Sub-Store
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"

          if [ ! -f "src-tauri/resources/sub-store/run-substore.js" ]; then
            echo "ERROR: Sub-Store run script not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store run script present"

          echo ""
          echo "=== All resources verified ==="
          ls -lh src-tauri/binaries/
          ls -lh src-tauri/resources/
          ls -lh src-tauri/resources/sub-store/

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          # Apple code signing (optional, configure secrets if needed)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          args: --target aarch64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
              echo "Checking resources..."
              ls -lh "$APP_PATH/Contents/Resources/resources/" || echo "No resources found!"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"
      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bundles
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for macOS x86_64 (Intel)
  build-macos-x86:
    name: Build macOS x86_64
    runs-on: macos-15-intel
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: macos-rust

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/mihomo-darwin-amd64
          key: mihomo-darwin-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: darwin-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/resources/

          # Check if file exists
          if [ ! -f "src-tauri/resources/mihomo-darwin-amd64" ]; then
            echo "ERROR: mihomo-darwin-amd64 not found!"
            exit 1
          fi

          # Check file size (should be > 10MB)
          FILE_SIZE=$(stat -f%z "src-tauri/resources/mihomo-darwin-amd64" 2>/dev/null || stat -c%s "src-tauri/resources/mihomo-darwin-amd64")
          MIN_SIZE=10000000  # 10MB
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-darwin-amd64 is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-darwin-amd64 verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-apple-darwin
          key: node-darwin-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: darwin-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-latest-v1

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        run: |
          echo "=== Verifying all required resources ==="

          # Check Node.js
          if [ ! -f "src-tauri/binaries/node-x86_64-apple-darwin" ]; then
            echo "ERROR: Node.js binary not found!"
            exit 1
          fi
          echo "‚úÖ Node.js binary present"

          # Check Sub-Store
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"

          if [ ! -f "src-tauri/resources/sub-store/run-substore.js" ]; then
            echo "ERROR: Sub-Store run script not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store run script present"

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (macOS x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          # Apple code signing (optional)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          args: --target x86_64-apple-darwin -c src-tauri/tauri.macos.conf.json

      - name: Verify build artifacts
        run: |
          echo "=== Checking build artifacts ==="
          APP_PATH="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/Conflux.app"
          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Conflux.app size: ${APP_SIZE}MB"
            if [ "$APP_SIZE" -lt 50 ]; then
              echo "‚ö†Ô∏è WARNING: .app is smaller than expected (${APP_SIZE}MB < 50MB)"
              echo "Checking resources..."
              ls -lh "$APP_PATH/Contents/Resources/resources/" || echo "No resources found!"
            else
              echo "‚úÖ .app size verified: ${APP_SIZE}MB"
            fi
          fi
          
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || echo "No DMG found"
      - name: Upload macOS x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-bundles
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # Build for Windows x86_64
  build-windows-x86:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: windows-rust

      - name: Cache WIX and NSIS toolsets
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\tauri\WixTools
            ~\AppData\Local\tauri\NSIS
          key: windows-tauri-tools-wix314-nsis3.11

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache MiHomo binaries
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/mihomo-windows-amd64.exe
          key: mihomo-windows-amd64-v1

      - name: Fetch MiHomo binaries
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MIHOMO_PLATFORM: windows-amd64
        run: |
          chmod +x scripts/fetch-mihomo.sh
          ./scripts/fetch-mihomo.sh

      - name: Verify MiHomo binaries
        shell: bash
        run: |
          echo "Checking MiHomo binaries..."
          ls -lh src-tauri/resources/

          # Check if file exists
          if [ ! -f "src-tauri/resources/mihomo-windows-amd64.exe" ]; then
            echo "ERROR: mihomo-windows-amd64.exe not found!"
            exit 1
          fi

          # Check file size (should be > 10MB)
          FILE_SIZE=$(stat -c%s "src-tauri/resources/mihomo-windows-amd64.exe" 2>/dev/null || wc -c < "src-tauri/resources/mihomo-windows-amd64.exe")
          MIN_SIZE=10000000  # 10MB
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "ERROR: mihomo-windows-amd64.exe is too small ($FILE_SIZE bytes). Expected > 10MB"
            exit 1
          fi
          echo "‚úÖ mihomo-windows-amd64.exe verified: $FILE_SIZE bytes"

      - name: Cache Node.js binaries
        id: cache-node
        uses: actions/cache@v4
        with:
          path: src-tauri/binaries/node-x86_64-pc-windows-msvc.exe
          key: node-win-x64-v20.18.2

      - name: Fetch Node.js binaries
        if: steps.cache-node.outputs.cache-hit != 'true'
        shell: bash
        env:
          NODE_PLATFORM: win-x64
        run: |
          chmod +x scripts/fetch-node.sh
          ./scripts/fetch-node.sh

      - name: Cache Sub-Store
        id: cache-substore
        uses: actions/cache@v4
        with:
          path: src-tauri/resources/sub-store
          key: substore-latest-v1

      - name: Fetch Sub-Store
        if: steps.cache-substore.outputs.cache-hit != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/fetch-substore.sh
          ./scripts/fetch-substore.sh

      - name: Verify all resources
        shell: bash
        run: |
          echo "=== Verifying all required resources ==="

          # Check Node.js
          if [ ! -f "src-tauri/binaries/node-x86_64-pc-windows-msvc.exe" ]; then
            echo "ERROR: Node.js binary not found!"
            exit 1
          fi
          echo "‚úÖ Node.js binary present"

          # Check Sub-Store
          if [ ! -f "src-tauri/resources/sub-store/sub-store.bundle.js" ]; then
            echo "ERROR: Sub-Store bundle not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store bundle present"

          if [ ! -f "src-tauri/resources/sub-store/run-substore.js" ]; then
            echo "ERROR: Sub-Store run script not found!"
            exit 1
          fi
          echo "‚úÖ Sub-Store run script present"

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (Windows x86_64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          # Windows code signing (optional)
          # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          args: --target x86_64-pc-windows-msvc -c src-tauri/tauri.windows.conf.json

      - name: Verify build artifacts
        shell: bash
        run: |
          echo "=== Checking build artifacts ==="
          echo "NSIS installers:"
          find src-tauri/target -name "*-setup.exe" -exec ls -lh {} \; 2>/dev/null || echo "No NSIS installer found"
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64-bundles
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*-setup.exe
          if-no-files-found: error

  # Optional: Create a combined release after all builds complete
  finalize-release:
    name: Finalize Release
    needs: [build-macos-arm64, build-macos-x86, build-windows-x86]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true
      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ env.RELEASE_BODY }}
          draft: true
          prerelease: false
          target_commitish: ${{ github.sha }}
          files: release-assets/**/*
        env:
          GITHUB_TOKEN: ${{ github.token }}
      - name: Release Summary
        run: |
          echo "‚úÖ All platform builds completed successfully!"
          echo ""
          echo "üì¶ Built artifacts:"
          echo "  - macOS ARM64 (Apple Silicon): .dmg"
          echo "  - macOS x86_64 (Intel): .dmg"  
          echo "  - Windows x86_64: NSIS installer (.exe)"
          echo ""
          echo "üîó Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag_name || github.ref_name }}"
